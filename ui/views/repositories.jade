extends layout

block navigation
	nav(class="navbar navbar-expand-lg navbar-light fixed-top repositories", id="mainNav")
		a(class="navbar-brand", href="/") GitHub Vacation
		button(class="navbar-toggler navbar-toggler-right", type="button", data-toggle="collapse", data-target="#navbarResponsive", aria-controls="navbarResponsive", aria-expanded="false", aria-label="Toggle navigation")
			img(src="#{avatar_url}", style="max-width: 35px;")

		div(class="collapse navbar-collapse", id="navbarResponsive")
			ul(class="navbar-nav ml-auto")
				li(class="nav-item")
					a(class="nav-link", href="/logout") Sign Out #{username}

block content
	div(class="container repositories")
		div(class="row")
			each vacationRepository, i in vacationRepositories
				- var repository = vacationRepository.repository;

				div(class=".col-12 col-sm-12 col-md-6 col-lg-4 col-xl-4" id="repositoryCard#{repository.name}")
					div(class="card", style="margin-top: 10px;")
						div(class="card-body")
							h4(class="card-title") #{repository.name}
							h6(class="card-subtitle mb-2 text-muted") #{repository.owner}

							form
								div(class="form-group")
									div(class="form-check")
										label(class="form-check-label")
											input(class="form-check-input", id="vacationMode#{repository.name}", type="checkbox", checked=(vacationRepository.enabled ? "checked" : undefined))
											| Vacation Mode

								div(class="form-group")
									label(for="exampleFormControlTextarea1") Pull Request Comment
									textarea(class="form-control", id="comment#{repository.name}", rows="3") #{vacationRepository.comment}

								button(class="btn btn-primary", type="button", onclick="enable('#{repository.owner}', '#{repository.name}');") Save
						div(class="card-footer text-muted")
							| 2 days ago

	script.
		var socket = io.connect('https://github-vacation.wedeploy.io');
		function enable(owner, repo) {
			var saveButton = $('#repositoryCard' + repo + ' button');

			saveButton.attr('class', 'btn btn-warning');
			saveButton.html('<i class="fa fa-spinner fa-spin"></i> Saving...')

			setTimeout(
				function () {
					socket.emit(
						'vacation',
						{
							'owner': owner,
							'repo': repo,
							'vacationMode': ($('#vacationMode' + repo).is(":checked")),
							'comment': $('#comment' + repo).val()
						}
					);
				},
				500);
		}

		socket.on(
			'saved',
			function (data) {
				var saveButton = $('#repositoryCard' + data.repo + ' button');

				saveButton.attr('class', 'btn btn-success');
				saveButton.html('<i class="fa fa-check"></i> Saved');

				setTimeout(
					function () {
						var saveButton = $('#repositoryCard' + data.repo + ' button');

						saveButton.attr('class', 'btn btn-primary');
						saveButton.html('Save');
					},
					2000);
			}
		);

